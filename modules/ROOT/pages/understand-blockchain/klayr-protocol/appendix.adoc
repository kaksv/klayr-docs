= Appendix
:description: The appendix contains additional information related to the Klayr protocol.
:imagesdir: ../assets/images
:page-no-next: true
:url_github_bip_39: https://github.com/bitcoin/bips/blob/master/bip-0039.mediawiki#generating-the-mnemonic
:url_github_bip_173: https://github.com/bitcoin/bips/blob/master/bip-0173.mediawiki
:url_github_lip_9: https://github.com/KlayrHQ/lips/blob/master/proposals/lip-0009.md#specification
:url_github_lip_18: https://github.com/KlayrHQ/lips/blob/master/proposals/lip-0018.md
:url_github_lip_24: https://github.com/KlayrHQ/lips/blob/master/proposals/lip-0024.md#update-to-the-block-header-signing-procedure
:url_github_lip_27: https://github.com/KlayrHQ/lips/blob/master/proposals/lip-0027.md
:url_github_lip_28: https://github.com/KlayrHQ/lips/blob/master/proposals/lip-0028.md
:url_github_lip_29: https://github.com/KlayrHQ/lips/blob/master/proposals/lip-0029.md
:url_github_lip_30: https://github.com/KlayrHQ/lips/blob/master/proposals/lip-0030.md
:url_ed225519: https://ed25519.cr.yp.to/
:url_google_developers_buffers: https://developers.google.com/protocol-buffers/docs/encoding
:url_wikipedia_sha2: https://en.wikipedia.org/wiki/SHA-2
:url_wikipedia_signatures: https://en.wikipedia.org/wiki/Digital_signature

[[serialization]]
== Serialization
The Klayr protocol specifies in {url_github_lip_27}[LIP 0027] how to serialize objects used by the protocol.
Generating a binary message from a JavaScript object is performed by following a stricter version of the {url_google_developers_buffers}[Protocol Buffers] specification.
Objects to be encoded have their format specified in a JSON schema.
The schemas for transactions, blocks and accounts can be found in {url_github_lip_28}[LIP 0028], {url_github_lip_29}[LIP 0029] and {url_github_lip_30}[LIP 0030] respectively.

[[signature_scheme]]
== Signature scheme
The Klayr protocol uses the Ed25519 signature scheme (see {url_wikipedia_signatures}[Wikipedia page] and the specification page for {url_ed225519}[Ed225519]).
The signing procedure uses the message and the private key of the signer to generate 64 bytes, called the signature.
Other users can then verify this signature with respect to the message and the public key of the signer.

In the Klayr protocol the procedure for signing blocks and transactions is as follows:

. Serialize the object into the corresponding binary message.
. Prepend the 32 bytes network identifier to the binary message (see {url_github_lip_9}[LIP 0009] and {url_github_lip_24}[LIP 0024]).
The network identifier  uniquely binds a transaction or a block to one network.
Different blockchains created with the Klayr SDK should use different network identifiers to avoid transaction replay between chains.
. Compute the signature of the output of step 2 above, as described in the Ed25519 specifications.

image::protocol/signatureProcess.svg[signature_process]

[[verifying_signatures]]
=== Verifying signatures
The network identifier is not transmitted with the binary message.
The procedure to verify transactions is therefore as follows:

. Remove the signature from the object received.
. Serialize the output of step 1 to a binary message.
. Prepend the network identifier to the binary message.
. Verify the output of step 3 with respect to the signature and the signer public key.


== Object ID
The Klayr ecosystem uses IDs to identify objects, such as blocks and transactions.
The ID is obtained by serializing the object, including the signature, and taking the SHA-256 (Secure Hash Algorithm 256), hash. See the {url_wikipedia_sha2}[Wikipedia page] of this binary message.

image::protocol/objectID.svg[objectID]


== Address


=== Key pair and address creation
To create a new address, first a 12-word passphrase is generated following the specifications of {url_github_bip_39}[BIP39].
The passphrase is then hashed using the SHA-256 into a 256-bit string. The resulting hash is used as the seed to generate the [#index-private_key-1]#*private key*# and the [#index-public_key-1]#*public key*# using Ed25519 signature scheme.
Finally, the [#index-address-1]#address# is generated by taking the first 20 bytes of the SHA-256 hash of the public key.

image::protocol/addressCreation.svg[addressCreation]

[[user_friendly_address]]
=== Klayr32 representation
We display addresses in their *Klayr32 representation* which includes a checksum and the "kly" prefix.
The procedure to obtain the Klayr32 representation of an address is as follows:

. Calculate a 30-bit checksum of the address of the account using a BCH code, see {url_github_bip_173}[BIP173].
This step provides protection against accidental typing mistakes.
. Concatenate the address and the output of step 1.
. Encode the output of step 2 in a custom Base32 format, see {url_github_lip_18}[LIP 0018] for details.
Lower-case letters and digits are used, the characters i, l, 1 and 0 are removed for usability reasons.
. Add the prefix "kly" to the output of step 3.
This ensures that the Klayr32 representation used in the Klayr wallet start with "kly" and that the final address is 41 characters long.

As an example, the address `0xc247a42e09e6aafd818821f75b2f5b0de47c8235` has the Klayr32 representation `kly24cd35u4jdq8szo3pnsqe5dsxwrnazyqqqg5eu`.
